{"mappings":"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","sources":["src/nitrous.ts","src/events.ts","src/errors.ts","src/requests.ts"],"sourcesContent":["import type { NitrousConstructor } from './types';\nimport { NitrousClickListener, NitrousSubmitListener } from './events';\nimport { NitrousError } from './errors';\n\nexport type { Nitrous } from './types';\n\nexport type NitrousOptions = {\n    include?: string | string[];\n    exclude?: string | string[];\n    swapTitle?: boolean;\n}\n\nexport function defineNitrous(name: `${string}-${string}`, {\n    include = ['a', 'area'],\n    exclude = [],\n    swapTitle = true,\n}: NitrousOptions = {}): NitrousConstructor {\n    return class Nitrous extends HTMLElement {\n        static { customElements.define(name, this); }\n        static swapTitle = swapTitle;\n\n        private readonly _parser = new DOMParser();\n        private readonly _onClick = new NitrousClickListener(this);\n        private readonly _onSubmit = new NitrousSubmitListener(this);\n        private _include = include instanceof Array ? include.join(', ') : include;\n        private _exclude = exclude instanceof Array ? exclude.join(', ') : exclude;\n\n        get include(): string { return this._include; }\n        set include(value: string | string[]) {\n            this._include = value instanceof Array ? value.join(',') : value;\n        }\n\n        get exclude(): string { return this._exclude; }\n        set exclude(value: string | string[]) {\n            this._exclude = value instanceof Array ? value.join(',') : value;\n        }\n\n        get target() { return this.getAttribute('target') ?? ''; }\n        set target(value: string) {\n            this.setAttribute('target', value);\n        }\n\n        connectedCallback() {\n            this.register();\n        }\n\n        disconnectedCallback() {\n            this.unregister();\n        }\n\n        register(root: ParentNode = this): void {\n            for (const el of root.querySelectorAll(this._include)) {\n                if (el.matches(this._exclude)) {\n                    continue;\n                }\n\n                switch (true) {\n                    case el instanceof HTMLAnchorElement && el.dataset['nitrous'] !== 'false':\n                    case el instanceof HTMLAreaElement && el.dataset['nitrous'] !== 'false':\n                        el.addEventListener('click', this._onClick);\n                        break;\n                    case el instanceof HTMLFormElement && el.dataset['nitrous'] !== 'false':\n                        el.addEventListener('submit', this._onSubmit);\n                        break;\n                    default:\n                        continue;\n                }\n            }\n        }\n\n        unregister(root: ParentNode = this): void {\n            for (const el of root.querySelectorAll(this._include)) {\n                if (el.matches(this._exclude)) {\n                    continue;\n                }\n\n                switch (true) {\n                    case el instanceof HTMLAnchorElement && el.dataset['nitrous'] !== 'false':\n                    case el instanceof HTMLAreaElement && el.dataset['nitrous'] !== 'false':\n                        el.removeEventListener('click', this._onClick);\n                        break;\n                    case el instanceof HTMLFormElement && el.dataset['nitrous'] !== 'false':\n                        el.removeEventListener('submit', this._onSubmit);\n                        break;\n                    default:\n                        continue;\n                }\n            }\n        }\n\n        swap(html: string, target?: Element | null): void;\n        swap(dom: Document, target?: Element | null): void;\n        swap(input: string | Document, target: Element | null = null): void {\n            const dom = typeof input === 'string'\n                ? this._parser.parseFromString(input, 'text/html')\n                : input;\n\n            target ??= this.querySelector(this.target);\n            if (!target) {\n                throw new NitrousError(`Target '${this.target}' does not exist`);\n            }\n\n            target.replaceChildren(\n                ...Array\n                    .from(dom.body.childNodes)\n                    .map(node => document.adoptNode(node))\n            );\n\n            if (Nitrous.swapTitle) {\n                document.title = dom.title;\n            }\n        }\n    }\n}\n","import type { DelegatedEvent, HyperlinkElement, Nitrous } from './types';\nimport { NitrousResponseError } from './errors';\nimport { NitrousFormRequest, NitrousHyperlinkRequest } from './requests';\n\nabstract class NitrousRequestHandler {\n    private _controller = new AbortController();\n\n    constructor(\n        protected readonly nitrous: Nitrous,\n        private readonly timeout?: number,\n    ) {\n    }\n\n    abort(reason?: unknown): void {\n        this._controller.abort(reason);\n        this._controller = new AbortController();\n    }\n\n    protected async handleRequest(req: Request, target: Element | null): Promise<void> {\n        const signal = !this.timeout\n            ? this._controller.signal\n            : AbortSignal.any([\n                AbortSignal.timeout(this.timeout),\n                this._controller.signal\n            ]);\n\n        const res = await fetch(req, {\n            signal,\n        });\n\n        if (!res.ok) {\n            throw new NitrousResponseError(\n                `Invalid status code: '${res.status} ${res.statusText}'`,\n                { response: res },\n            );\n        }\n\n        const html = await res.text();\n        this.nitrous.swap(html, target);\n    }\n}\n\nexport class NitrousClickListener extends NitrousRequestHandler implements EventListenerObject {\n    handleEvent(e: DelegatedEvent<MouseEvent, HyperlinkElement>): void {\n        e.preventDefault();\n\n        const req = new NitrousHyperlinkRequest(e.target, {\n            nitrous: {\n                target: this.nitrous.target,\n            },\n        });\n\n        const target = e.target.dataset['target']\n            ? this.nitrous.querySelector(e.target.dataset['target'])\n            : null;\n\n        this.handleRequest(req, target).catch(console.error);\n    }\n}\n\nexport class NitrousSubmitListener extends NitrousRequestHandler implements EventListenerObject {\n    handleEvent(e: DelegatedEvent<SubmitEvent, HTMLFormElement>): void {\n        e.preventDefault();\n\n        const req = new NitrousFormRequest(e.target, {\n            nitrous: {\n                target: this.nitrous.target,\n            },\n        });\n\n        const target = e.target.dataset['target']\n            ? this.nitrous.querySelector(e.target.dataset['target'])\n            : null;\n        \n        this.handleRequest(req, target).catch(console.error);\n    }\n}\n","export class NitrousError extends Error { }\n\nexport type NitrousResponseErrorOptions = ErrorOptions & {\n    response: Response,\n}\n\nexport class NitrousResponseError extends NitrousError {\n    readonly status: number;\n    readonly statusText: string;\n    readonly headers: Headers;\n\n    constructor(message: string, { response, ...options }: NitrousResponseErrorOptions) {\n        super(message, options);\n\n        this.status = response.status;\n        this.statusText = response.statusText;\n        this.headers = response.headers;\n    }\n}\n\n","export type NitrousInit = {\n    trigger?: string;\n    target?: string;\n}\n\nexport type NitrousRequestInit = RequestInit & {\n    nitrous?: NitrousInit;\n};\n\nexport default class NitrousRequest extends Request {\n    readonly nitrous: NitrousInit;\n\n    constructor(input: RequestInfo | URL, {\n        headers: originalHeaders = {},\n        nitrous = {},\n        ...init\n    }: NitrousRequestInit = {}) {\n        const headers: HeadersInit = {\n            ...originalHeaders,\n            Accept: 'text/html',\n            'Accept-Charset': 'utf-8',\n            'X-Requested-With': 'Nitrous',\n            ...(\n                nitrous.trigger\n                    ? { 'X-Nitrous-Trigger': nitrous.trigger }\n                    : {}\n            ),\n            ...(\n                nitrous.target\n                    ? { 'X-Nitrous-Target': nitrous.target }\n                    : {}\n            ),\n        };\n\n        super(input, { ...init, headers });\n        this.nitrous = nitrous;\n    }\n}\n\nexport type NitrousElementRequestInit = Omit<NitrousRequestInit, 'method' | 'body' | 'nitrous'> & {\n    nitrous?: Omit<NitrousInit, 'trigger'>;\n};\n\nexport class NitrousHyperlinkRequest extends NitrousRequest {\n    constructor(el: Element & HTMLHyperlinkElementUtils, {\n        nitrous = {},\n        ...init\n    }: NitrousElementRequestInit = {}) {\n        super(el.href, {\n            ...init,\n            method: 'GET',\n            nitrous: {\n                ...nitrous,\n                trigger: el.id,\n            }\n        });\n    }\n}\n\nexport class NitrousFormRequest extends NitrousRequest {\n    constructor(el: HTMLFormElement, {\n        nitrous = {},\n        ...init\n    }: NitrousElementRequestInit) {\n        const data = new FormData(el);\n\n        const body: BodyInit = el.enctype !== 'multipart/form-data'\n            ? new URLSearchParams([...data.entries()] as ([string, string])[])\n            : data;\n\n        super(el.action, {\n            ...init,\n            method: el.method,\n            body,\n            nitrous: {\n                ...nitrous,\n                trigger: el.id,\n            }\n        });\n    }\n}\n"],"names":[],"version":3,"file":"nitrous.js.map"}